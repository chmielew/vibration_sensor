/** main.c */
//////////////////////////////////////////////////////////////////////////////////////////
//Includes																				//
//////////////////////////////////////////////////////////////////////////////////////////
/** basic includes */
#include "freertos/FreeRTOS.h"
#include "esp_system.h"
#include "esp_event.h"
#include "esp_event_loop.h"
#include "nvs_flash.h"

/** application includes */
#include "task_creator.h"
#include "../components/heartbeat/heartbeat.h"
#include "../components/ble_communication/ble_communication.h"
#include "../components/threshold_exceeded_notification/threshold_exceeded_notification.h"
#include "../components/measurement/measurement.h"

/** debug includes*/
#include "esp_log.h"
extern uint16_t current_measurement;
//////////////////////////////////////////////////////////////////////////////////////////
//Macros																				//
//////////////////////////////////////////////////////////////////////////////////////////
#define ACCELEROMETER_ADC_CHANNEL (ADC1_CHANNEL_7)
//////////////////////////////////////////////////////////////////////////////////////////
//Local typedefs																		//
//////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////
//Static functions prototypes															//
//////////////////////////////////////////////////////////////////////////////////////////
/****************************************************************************************\
Function:
entry_initialization
******************************************************************************************
Parameters:
None.
******************************************************************************************
Abstract:
This function calls the init functions.
\****************************************************************************************/
void entry_initialization(void);
//////////////////////////////////////////////////////////////////////////////////////////
//Static variables																		//
//////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////
//Global functions definitions															//
//////////////////////////////////////////////////////////////////////////////////////////

void app_main(void)
{
	entry_initialization();
	entry_task_creator();
	uint16_t * measurement_ptr;
	measurement_ptr = measurement_trigger(10, 2);

    while (1) {
    	ESP_LOGI("A", "%d", current_measurement);
    	if(20 == current_measurement){
    		for(uint8_t a=0; a<20; a++){
    		    	ESP_LOGI("before", "%d", *(measurement_ptr+a));
    		    	}
    		free(measurement_ptr);
    		measurement_ptr = measurement_trigger(10, 2);
    		for(uint8_t a=0; a<20; a++){
    		    	ESP_LOGI("After", "%d", *(measurement_ptr+a));
    		    	}
    	}
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
}

//////////////////////////////////////////////////////////////////////////////////////////
//Static functions definitions															//
//////////////////////////////////////////////////////////////////////////////////////////

void entry_initialization(void)
{
	nvs_flash_init();
	heartbeat_init();

	ble_communication_init();
	measurement_Init(ACCELEROMETER_ADC_CHANNEL, ADC_ATTEN_DB_11, ADC_WIDTH_BIT_12);
//	threshold_exceeded_init(4000);
	measurement_trigger(1, 1);
}

//////////////////////////////////////////////////////////////////////////////////////////




//////////////////////////////////////////////////////////////////////////////////////////
//End of file																			//
//////////////////////////////////////////////////////////////////////////////////////////
